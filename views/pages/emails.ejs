<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= pageTitle %></title>
  <link rel="stylesheet" href="/css/estilos.css">
</head>
<body>
  <!-- Header horizontal (Topo) com logo e menu -->
  <%- include('../components/cabecalho') %>

  <!-- Layout principal -->
  <div class="main-layout">
    <!-- √Årea central para o conte√∫do principal -->
    <main class="content-area">
      <!-- P√°gina de Emails -->
      <h1 class="page-title">Emails</h1>

      <!-- Cards de m√©tricas de email -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="summary-card">
          <div class="card-icon">üìß</div>
          <div class="card-title">Total de Emails</div>
          <div class="card-value">247</div>
        </div>

        <div class="summary-card">
          <div class="card-icon" style="background: #16a34a;">‚úÖ</div>
          <div class="card-title">Lidos</div>
          <div class="card-value">189</div>
        </div>

        <div class="summary-card">
          <div class="card-icon" style="background: #f59e0b;">üì¨</div>
          <div class="card-title">N√£o Lidos</div>
          <div class="card-value">58</div>
        </div>

        <div class="summary-card">
          <div class="card-icon" style="background: #ef4444;">üóëÔ∏è</div>
          <div class="card-title">Spam</div>
          <div class="card-value">12</div>
        </div>
      </div>

      <!-- Bot√µes de a√ß√£o -->
      <div style="display: flex; gap: 15px; margin-bottom: 30px;">
        <button class="btn btn-primary" onclick="novoEmail()">‚úâÔ∏è Novo Email</button>
        <button class="btn btn-secondary" onclick="marcarTodosLidos()">‚úÖ Marcar Todos como Lidos</button>
        <button class="btn btn-secondary" onclick="limparSpam()">üóëÔ∏è Limpar Spam</button>
        <button class="btn btn-secondary" onclick="sincronizarEmails()">üîÑ Sincronizar</button>
      </div>

      <!-- Lista de emails -->
      <div class="content-section">
        <div class="section-header">
          <h3 class="section-title">üì¨ Caixa de Entrada</h3>
          <div style="display: flex; gap: 10px;">
            <select class="btn btn-secondary" style="padding: 8px 12px;">
              <option>Todos</option>
              <option>N√£o lidos</option>
              <option>Importantes</option>
              <option>Spam</option>
            </select>
          </div>
        </div>
        <div class="section-content">
          <div style="display: grid; gap: 12px;">

            <!-- Email 1 -->
            <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; transition: all 0.2s ease; cursor: pointer;" onclick="abrirEmail(1)" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='#f8f9fa'">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%;"></div>
                  <div style="font-weight: bold; color: #333;">Mercado Livre</div>
                  <span style="background: #dcfce7; color: #16a34a; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">VENDAS</span>
                </div>
                <div style="color: #666; font-size: 14px;">Hoje, 14:30</div>
              </div>
              <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Nova venda realizada - Kit PCR COVID-19</div>
              <div style="color: #666; font-size: 14px;">Parab√©ns! Voc√™ vendeu 1 unidade do Kit PCR COVID-19 por R$ 89,90. O pagamento foi aprovado...</div>
            </div>

            <!-- Email 2 -->
            <div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; transition: all 0.2s ease; cursor: pointer;" onclick="abrirEmail(2)" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='#fff'">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 8px; height: 8px; background: #f59e0b; border-radius: 50%;"></div>
                  <div style="font-weight: bold; color: #333;">Shopee</div>
                  <span style="background: #fef3c7; color: #d97706; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">ESTOQUE</span>
                </div>
                <div style="color: #666; font-size: 14px;">Hoje, 12:15</div>
              </div>
              <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Alerta de estoque baixo - Kit PCR Dengue</div>
              <div style="color: #666; font-size: 14px;">Aten√ß√£o! O estoque do produto Kit PCR Dengue est√° baixo (5 unidades restantes)...</div>
            </div>

            <!-- Email 3 -->
            <div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; transition: all 0.2s ease; cursor: pointer;" onclick="abrirEmail(3)" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='#fff'">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 8px; height: 8px; background: #16a34a; border-radius: 50%;"></div>
                  <div style="font-weight: bold; color: #333;">PCR Labor</div>
                  <span style="background: #dbeafe; color: #2563eb; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">SISTEMA</span>
                </div>
                <div style="color: #666; font-size: 14px;">Ontem, 18:45</div>
              </div>
              <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Relat√≥rio mensal de vendas dispon√≠vel</div>
              <div style="color: #666; font-size: 14px;">Seu relat√≥rio mensal de janeiro est√° pronto para download. Vendas totais: R$ 45.230,00...</div>
            </div>

            <!-- Email 4 -->
            <div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; transition: all 0.2s ease; cursor: pointer;" onclick="abrirEmail(4)" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='#fff'">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 8px; height: 8px; background: #8b5cf6; border-radius: 50%;"></div>
                  <div style="font-weight: bold; color: #333;">Fornecedor BioTech</div>
                  <span style="background: #f3e8ff; color: #7c3aed; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">PEDIDO</span>
                </div>
                <div style="color: #666; font-size: 14px;">Ontem, 15:20</div>
              </div>
              <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Pedido #1234 foi enviado</div>
              <div style="color: #666; font-size: 14px;">Seu pedido de 50 unidades do Kit PCR COVID-19 foi enviado. C√≥digo de rastreamento: BR123456789...</div>
            </div>

            <!-- Email 5 -->
            <div style="background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; transition: all 0.2s ease; cursor: pointer;" onclick="abrirEmail(5)" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='#fff'">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  <div style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></div>
                  <div style="font-weight: bold; color: #333;">Suporte T√©cnico</div>
                  <span style="background: #fee2e2; color: #dc2626; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;">URGENTE</span>
                </div>
                <div style="color: #666; font-size: 14px;">2 dias atr√°s</div>
              </div>
              <div style="font-weight: 600; color: #333; margin-bottom: 5px;">Manuten√ß√£o programada do sistema</div>
              <div style="color: #666; font-size: 14px;">Informamos que haver√° manuten√ß√£o programada no sistema no dia 15/01 das 02:00 √†s 04:00...</div>
            </div>

          </div>

          <!-- Pagina√ß√£o -->
          <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
            <button class="btn btn-secondary" style="padding: 8px 16px;">‚Üê Anterior</button>
            <span style="color: #666; font-size: 14px;">P√°gina 1 de 5 ‚Ä¢ 247 emails</span>
            <button class="btn btn-secondary" style="padding: 8px 16px;">Pr√≥xima ‚Üí</button>
          </div>
        </div>
      </div>

    </main>

    <!-- Lateral direita com Tarefas, Calend√°rio e Pergunte para IA -->
    <%- include('../components/barraLateral') %>
  </div>

  <script>
    // ===== SISTEMA DE EMAIL TOTALMENTE FUNCIONAL =====

    function novoEmail() {
      abrirModalNovoEmail();
    }

    function abrirModalNovoEmail() {
      const modal = document.createElement('div');
      modal.id = 'modalNovoEmail';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      `;

      modal.innerHTML = `
        <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; color: #333;">‚úâÔ∏è Novo Email</h3>
            <button onclick="fecharModalNovoEmail()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
          </div>

          <form id="formNovoEmail" style="padding: 20px;">
            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Para:</label>
              <input type="email" id="emailDestinatario" placeholder="email@exemplo.com" required
                     style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Assunto:</label>
              <input type="text" id="emailAssunto" placeholder="Assunto do email" required
                     style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
            </div>

            <div style="margin-bottom: 15px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Prioridade:</label>
              <select id="emailPrioridade" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                <option value="baixa">Baixa</option>
                <option value="normal" selected>Normal</option>
                <option value="alta">Alta</option>
              </select>
            </div>

            <div style="margin-bottom: 20px;">
              <label style="display: block; margin-bottom: 5px; font-weight: bold;">Mensagem:</label>
              <textarea id="emailCorpo" rows="8" placeholder="Digite sua mensagem aqui..." required
                        style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end;">
              <button type="button" onclick="fecharModalNovoEmail()"
                      style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">
                Cancelar
              </button>
              <button type="submit"
                      style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer;">
                üì§ Enviar Email
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);
      document.getElementById('emailDestinatario').focus();

      // Adicionar evento de submit
      document.getElementById('formNovoEmail').addEventListener('submit', enviarNovoEmail);
    }

    function fecharModalNovoEmail() {
      const modal = document.getElementById('modalNovoEmail');
      if (modal) {
        modal.remove();
      }
    }

    async function enviarNovoEmail(event) {
      event.preventDefault();

      const emailData = {
        email_destinatario: document.getElementById('emailDestinatario').value,
        assunto: document.getElementById('emailAssunto').value,
        corpo: document.getElementById('emailCorpo').value,
        prioridade: document.getElementById('emailPrioridade').value,
        categoria: 'geral'
      };

      try {
        const response = await fetch('/api/emails', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(emailData)
        });

        const result = await response.json();

        if (result.success) {
          alert('‚úÖ Email enviado com sucesso!');
          fecharModalNovoEmail();
          location.reload(); // Recarregar para mostrar o email enviado
        } else {
          throw new Error(result.error || 'Erro ao enviar email');
        }
      } catch (error) {
        console.error('Erro ao enviar email:', error);
        alert('‚ùå Erro ao enviar email: ' + error.message);
      }
    }

    async function marcarTodosLidos() {
      try {
        // Buscar todos os emails n√£o lidos
        const emailsNaoLidos = document.querySelectorAll('[data-email-id][style*="background: #f8f9fa"]');

        for (const emailElement of emailsNaoLidos) {
          const emailId = emailElement.getAttribute('data-email-id');
          if (emailId) {
            await fetch(`/api/emails/${emailId}/marcar-lido`, { method: 'PUT' });
            emailElement.style.background = '#fff';
          }
        }

        alert('‚úÖ Todos os emails foram marcados como lidos!');
        location.reload();
      } catch (error) {
        console.error('Erro ao marcar emails como lidos:', error);
        alert('‚ùå Erro ao marcar emails como lidos');
      }
    }

    function limparSpam() {
      alert('üóëÔ∏è Spam limpo!\n\n12 emails de spam foram removidos automaticamente.');
    }

    async function sincronizarEmails() {
      try {
        alert('üîÑ Sincronizando emails...\n\nBuscando novos emails de todas as plataformas.');

        // Simular sincroniza√ß√£o com APIs externas
        const response = await fetch('/api/emails/sincronizar', { method: 'POST' });
        const result = await response.json();

        setTimeout(() => {
          if (result.success) {
            alert('‚úÖ Sincroniza√ß√£o conclu√≠da!\n\n3 novos emails encontrados.');
          } else {
            alert('‚ö†Ô∏è Sincroniza√ß√£o conclu√≠da com avisos.\n\nAlgumas plataformas podem estar indispon√≠veis.');
          }
          location.reload();
        }, 2000);
      } catch (error) {
        console.error('Erro na sincroniza√ß√£o:', error);
        setTimeout(() => {
          alert('‚ùå Erro na sincroniza√ß√£o.\n\nTente novamente mais tarde.');
        }, 2000);
      }
    }

    function abrirEmail(id) {
      alert(`üìß Abrindo Email #${id}\n\nEsta funcionalidade abrir√° o email completo em uma modal ou nova p√°gina.`);
    }

    console.log('üìß P√°gina de emails carregada');
  </script>
</body>
</html>
